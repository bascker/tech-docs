# Kubectl
## 一、简介
kubectl 是 k8s 的命令行管理工具，通过它可以与 k8s 集群进行交互。

## 二、滚动升级
### 2.1 kubectl rolling-update
非常重要的命令，提供不中断业务的更新方式，且若更新发现问题，还可停止更新，回滚到之前的状态，但需要确保新的版本有不同的name，version和label, 否则更新失败

### 2.2 kubectl rollout
管理 deployment 的命令
```
# 查看一个 deployment 是否创建/升级成功
$ kubectl rollout status deployment/nova-consoleauth
deployment "nova-consoleauth" successfully rolled out

# 查看 rollout 历史
$ kubectl rollout history deployment/nginx-deployment
deployments "nginx-deployment":
REVISION    CHANGE-CAUSE
1        <none>

# 查看详细信息
$ kubectl rollout history deployment/nginx-deployment --revision 1`
deployments "nginx-deployment" revision 1
  Labels:    app=nginx
    pod-template-hash=2629547101
  Containers:
   nginx:
    Image:    nginx
    Port:    80/TCP
    Environment Variables:    <none>
  No volumes.

# kubectl rollout undo：取消升级, 回滚
$ kubectl rollout undo deployment/nginx-deployment
deployment "nginx-deployment" rolled back

$ kubectl rollout undo deployment/nginx-deployment --to-revision=2
deployment "nginx-deployment" rolled back
```

## 三、扩/缩容
### 3.1 kubectl scale
用于程序在负载加重或缩小时对副本进行扩容或缩小。
```
# 将 glance-api 从副本数为 1 扩容到 2
$ kubectl scale --replicas=2 deployment/glance-api
```

### 3.2 kubectl autoscale
提供自动根据pod负载对副本进行扩缩功能，自动扩缩需要给rc指定一个副本数的范围。
```
$ kubectl autoscale rc rc-nginx --min=1 --max=5 --cpu-percent=80
```

## 四、集群管理
### 4.1 连接远端 k8s 集群
kubectl 默认去连接本地的 k8s 集群，若要连接远端的 k8s 集群，可进行如下设置：以 k8s-con1 搭建好 k8s 后，在 k8s-con2 上连接 k8s-con1 上的集群为例
```
# 没设置好后，就会是这样
$ k8s get pod
The connection to the server localhost:8080 was refused - did you specify the right host or port?

$ ping 10.10.10.1
PING 10.10.10.1 (10.10.10.1) 56(84) bytes of data.
64 bytes from 10.10.10.1: icmp_seq=1 ttl=64 time=0.343 ms

$ kubectl config set-cluster k8s1 --server=http://10.10.10.1:8080
cluster "k8s1" set.

$ kubectl config set-context k8s1 --cluster=k8s1
context "k8s1" set.

$ kubectl config use-context k8s1
switched to context "k8s1".

$ k8s get nodes
NAME          STATUS    AGE
compute1      Ready     2h
compute2      Ready     2h
controller1   Ready     2h
controller2   Ready     2h
controller3   Ready     2h

# 使用远端集群的显示
$ kubectl config view
apiVersion: v1
clusters:
- cluster:
    server: http://10.10.10.1:8080
  name: k8s1
contexts:
- context:
    cluster: k8s1
    user: ""
  name: k8s1
current-context: k8s1
kind: Config
preferences: {}
users: []

# 使用本地集群的显示
$ kubectl config view
apiVersion: v1
clusters: []
contexts: []
current-context: ""
kind: Config
preferences: {}
users: []
```

### 4.2 连接 mariadb 服务
1.查看域名解析是否配置
```
$ vim /etc/resolv.conf
; generated by /usr/sbin/dhclient-script
search kolla.svc.cluster.local svc.cluster.local cluster.local
nameserver 20.0.0.2
options ndots:5
```

2.查看mariadb的svc
```
$ k8s get svc mariadb
NAME      CLUSTER-IP     EXTERNAL-IP   PORT(S)    AGE
mariadb   20.0.123.160   <none>        3306/TCP   1h
```

3.查看域名解析是否正常
```
$ ping mariadb
PING mariadb.kolla.svc.cluster.local (20.0.123.160) 56(84) bytes of data.        # 说明 ok
```

4.获取root用户数据库密码
```
$  grep ^data /etc/kolla/passwords.yml
database_password: gjkoVq5kTUC82a9qQQEjG9fdnch1O0i8ahDCFpUj
```

5.连接数据库
```
$ mysql -h mariadb -u root -pgjkoVq5kTUC82a9qQQEjG9fdnch1O0i8ahDCFpUj
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MariaDB connection id is 21
Server version: 10.0.26-MariaDB-wsrep MariaDB Server, wsrep_25.13.raf7f02e

Copyright (c) 2000, 2016, Oracle, MariaDB Corporation Ab and others.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

MariaDB [(none)]> show databases;
+--------------------+
| Database           |
+--------------------+
| glance             |
| information_schema |
| keystone           |
| mysql              |
| neutron            |
| performance_schema |
+--------------------+
6 rows in set (0.00 sec)
```